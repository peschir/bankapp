##Lessons learned with play and c3p0

I had big trouble to get the ClearDB SSL communication to work with play 2 and scala. So here my solution.

First of all you have to deal with keystore and truststore related topics
####KeyStore and TrustStore

######Definition
What i've learned is keystore and trustore are more or less based on the same file but for different purpose.
Here a simple summary what both means.
* trustore is used to validate server certificates 
* keystore is to validate client authentication

There a lot of good articles about the difference below are some of same

* [Stackoverflow discussion about](http://stackoverflow.com/questions/318441/truststore-and-keystore-definitions)
* [Java realted discussion](http://javarevisited.blogspot.de/2012/09/difference-between-truststore-vs-keyStore-Java-SSL.html)

######Usage

There are also a lot off tutorials how to setup custom keystore and truststore and here is my for the Java 7 JDK from oracle it could be not work with openjdk i don't try it with it.

First of all i had a special purpose for the truststore because it was used for different things the first one
is to get the ssl communication working with cleardb hosted mysql and second also web service requests from the play controller
to a external https endpoint. To get only the first thing to work you can build your own truststore contains only the cleardb server certificate.

But to get also the second thing to work you should copy the java standard truststore and import the cleardb server certificate to them.

Require the cleardb pem certifcates download at [ClearDB Dashboard](https://www.cleardb.com/dashboard). This certificate i guess are app specific so download it for your app you want to enable ssl communication for.

You need the two following files
* ClearDB CA Certificate
* Client Certificate

Store it in the same directory where you want to put your truststore and keystore file


* first step locate your java truststore called cacerts it should be found at [your jdk folder]/jre/lib/security/cacerts
for example on my ubuntu 14.04 system if found it at /usr/lib/jvm/java-7-oracle/jre/lib/security/cacerts
* second make a copy of it
```bash
cp /usr/lib/jvm/java-7-oracle/jre/lib/security/cacerts ./
```
* third import the ClearDB CA Certificate to the cacerts truststore you copied the first command list the existing certificates the should be round 80 entries could be more or less but to check that the import was successful it should contains one more
the cacerts password is changeit (was it )
```bash
  keytool -list -keystore cacerts
  keytool -import -alias clearDBCACert -file cleardb-ca.pem -keystore cacerts 
  keytool -list -keystore cacerts 
```
```bash
  keytool -list -keystore cacerts 
  keytool -list -keystore keystore
  keytool -import -alias clearDBCACert -file cleardb-ca.pem -keystore cacerts 
  keytool -list -keystore cacerts 
  keytool -import -file bfa19bff3390d4-cert.pem -keystore keystore -alias clearDBClientCertificate
  keytool -list -keystore keystore
```

* activate logging in play 2
```bash
play -Djavax.net.debug=true -Dcom.mchange.v2.log.MLog=com.mchange.v2.log.FallbackMLog -Dom.mchange.v2.log.FallbackMLog.DEFAULT_CUTOFF_LEVEL=ALL run
```
```scala
import play.api._
import play.api.mvc._

object Global extends WithFilters(HTTPSRedirectFilter) with GlobalSettings
{
    override def onStart(app: Application) {
      val enableDBSSL = app.configuration.getBoolean("enableDBSSL").getOrElse(true)
      val enablePoolLogging = app.configuration.getBoolean("enablePoolLogging").getOrElse(false)
      if(enableDBSSL) {
        Logger.info("set custom truststore for cleardb mysql ssl connections")
        WithSSL()
      }
      if(enablePoolLogging) {
        WithPoolLogging()
      }
      Logger.info("Application has started")
    }
    override def onStop(app: Application) {
      Logger.info("Application shutdown...")
    }
    def WithPoolLogging() {
     System.setProperty("com.mchange.v2.log.MLog","com.mchange.v2.log.FallbackMLog")
     System.setProperty("com.mchange.v2.log.FallbackMLog.DEFAULT_CUTOFF_LEVEL","ALL")
    }
    def WithSSL() {
      System.setProperty("javax.net.ssl.keyStore", "ssl/keystore")
      System.setProperty("javax.net.ssl.keyStorePassword", Properties.envOrElse("SSLPW", ""))
      System.setProperty("javax.net.ssl.trustStore", "ssl/cacerts")
      System.setProperty("javax.net.ssl.trustStorePassword", Properties.envOrElse("SSLPW2", ""))
    }
}
```
